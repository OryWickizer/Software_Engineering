name: Proj3 Deploy (No Docker)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment name"
        default: "production"
        required: true

jobs:
  build-artifacts:
    name: Build Client & Package Server
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install client deps
        working-directory: proj3/frontend
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      - name: Build client
        working-directory: proj3/frontend
        run: npm run build

      - name: Upload client dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: proj3-client-dist-${{ github.sha }}
          path: proj3/frontend/dist

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Package server (zip)
        working-directory: proj3/backend
        run: |
          zip -r server-${{ github.sha }}.zip app requirements.txt pyproject.toml

      - name: Upload server package artifact
        uses: actions/upload-artifact@v4
        with:
          name: proj3-server-package-${{ github.sha }}
          path: proj3/backend/server-${{ github.sha }}.zip
